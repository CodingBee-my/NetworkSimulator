function requestDHCPInfoCommand(a){var b=network.getElement(a);b.getApp("DHCPClient").requestInfo()}function editDHCPServerInfo(a){createBkDiv(),createDHCPServerInfoDiv(a)}function createDHCPServerInfoDiv(a){var b=network.getElement(a),c=b.getApp("DHCPServer"),d=(document.createElement("div"),'<input type="button" id="upload" value="Save" onclick="saveDHCPServerData('+a+');" />');d+='<input type="button" id="cancel" value="Cancel" onclick="cancelDHCPServerData();" />';var e=new UIWindow("divdhcpserverinfo","DHCP Server",400,250,!1,1);e.setContent(c.getAppController()),e.setControls(d),e.render()}function saveDHCPServerData(a){var b=network.getElement(a),c=document.getElementById("dhcpinitial").value,d=document.getElementById("dhcpend").value,e=document.getElementById("dhcpgw").value,f=document.getElementById("dhcpdns1").value,g=document.getElementById("dhcpdns2").value;b.getApp("DHCPServer").setData(c,d,e,f,g),removeBodyDiv("divbk"),uimanager.getWindow("divdhcpserverinfo").dispose()}function cancelDHCPServerData(){removeBodyDiv("divbk"),uimanager.getWindow("divdhcpserverinfo").dispose()}function createDNSLookup(a){createBkDiv(),createDNSLookupDiv(a)}function createDNSLookupDiv(a){var b=network.getElement(a),c=b.getApp("DNSClient"),d=document.createElement("div"),e=window.innerWidth/2-200,f=window.innerHeight/2-75;d.setAttribute("style","position:absolute;top:"+f+"px;left:"+e+"px;z-index:110;background-color:white;width:400px;height:150px;border-radius:10px;border:1px solid;padding:10px;text-align:center;"),d.setAttribute("id","divdnslookup"),d.innerHTML=c.getAppController(),d.innerHTML+='<p>  <input type="button" id="upload" value="Lookup" onclick="requestDNSLookup('+a+');" />  <input type="button" id="cancel" value="Cancel" onclick="cancelDNSLookup();" />  </p>',document.body.appendChild(d)}function cancelDNSLookup(){removeBodyDiv("divdnslookup"),removeBodyDiv("divbk")}function requestDNSLookup(a){var b=network.getElement(a),c=document.getElementById("dnsclientdomain").value;b.getApp("DNSClient").DNSLookup(c),removeBodyDiv("divdnslookup"),removeBodyDiv("divbk")}function setupDNSServerConfig(a){createBkDiv(),createDNSServerConfigDiv(a)}function createDNSServerConfigDiv(a){var b=network.getElement(a),c=b.getApp("DNSServer"),d=document.createElement("div"),e=window.innerWidth/2-200,f=window.innerHeight/2-200,g=["Domain","IP"],h=c.getAppControllerData(),i=new UITable(g,h,"dnstable");d.setAttribute("style","position:absolute;top:"+f+"px;left:"+e+"px;z-index:110;background-color:white;width:400px;height:400px;border-radius:10px;border:1px solid;padding:10px;text-align:center;"),d.setAttribute("id","divdnsserverconfig"),d.innerHTML=c.getAppController(),d.innerHTML+='<p>  <input type="button" id="upload" value="Save" onclick="saveDNSServerConfig('+a+",'"+i.getId()+'\');" />  <input type="button" id="cancel" value="Cancel" onclick="cancelDNSServerConfig(\''+i.getId()+"');\" />  </p>",document.body.appendChild(d),i.render()}function saveDNSServerConfig(a,b){var c=uitables[b].getData(),d=network.getElement(a),e=d.getApp("DNSServer");e.resetDNSTable();for(var f=0;f<c.length;f++)e.setEntry(c[f][0],c[f][1]);var g=document.getElementById("forwarder").value;e.setForwarder(g),removeBodyDiv("divdnsserverconfig"),removeBodyDiv("divbk"),uitables[b].dispose()}function cancelDNSServerConfig(a){removeBodyDiv("divdnsserverconfig"),removeBodyDiv("divbk"),uitables[a].dispose()}function createGatewaysDiv(a){var b=network.getElement(a),c=document.createElement("div"),d=window.innerWidth/2-200,e=window.innerHeight/2-200,f=["Network","Mask","Gateway"],g=b.getConnectable().getGatewayManager().getControllerData(),h=new UITable(f,g,"gwtable");c.setAttribute("style","position:absolute;top:"+e+"px;left:"+d+"px;z-index:110;background-color:white;width:700px;height:400px;border-radius:10px;border:1px solid;padding:10px;text-align:center;"),c.setAttribute("id","divgwconfig"),c.innerHTML=b.getConnectable().getGatewayManager().getController(),c.innerHTML+='<p>  <input type="button" id="upload" value="Save" onclick="saveGWConfig('+a+",'"+h.getId()+'\');" />  <input type="button" id="cancel" value="Cancel" onclick="cancelGWConfig(\''+h.getId()+"');\" />  </p>",document.body.appendChild(c),h.render()}function editGateways(a){createBkDiv(),createGatewaysDiv(a)}function cancelGWConfig(a){removeBodyDiv("divgwconfig"),removeBodyDiv("divbk"),uitables[a].dispose()}function saveGWConfig(a,b){var c=network.getElement(a);c.getConnectable().getGatewayManager().purgeGatewayInfo();for(var d=uitables[b].getData(),e=0;e<d.length;e++){var f=d[e][0];f=""===f?"0.0.0.0":f;var g=d[e][1];g=""===g?"0.0.0.0":g;var h=d[e][2];c.getConnectable().getGatewayManager().addGatewayInfo(f,g,h)}removeBodyDiv("divgwconfig"),removeBodyDiv("divbk"),uitables[b].dispose()}function getDinamycPort(){return++lastuseddinamycport}function getNextID(){return++lastusedid}function viewWebBrowser(a){createBkDiv();var b=network.getElement(a),c=b.getApp("HTTPClient"),d='<input type="button" id="close" value="Close" onclick="closeWebBrowser();" />',e=new UIWindow("divhttpclient","HTTP Client (Browser)",400,400,!1,1);e.setContent(c.getAppController()),e.setControls(d),e.render()}function closeWebBrowser(){removeBodyDiv("divbk"),uimanager.getWindow("divhttpclient").dispose()}function requestHTTPWebSite(a){var b=network.getElement(a),c=b.getApp("HTTPClient"),d=document.getElementById("httpclienturl").value;c.requestHTTPWebSite(d)}function editHTTPServerInfo(a){createBkDiv(),createHTTPServerInfoDiv1(a)}function createHTTPServerInfoDiv1(a){var b=network.getElement(a),c=b.getApp("HTTPServer"),d=document.createElement("div"),e=window.innerWidth/2-200,f=window.innerHeight/2-200,g=["Domain"],h=c.getAppControllerData1(),i=new UITable(g,h,"httptable");i.setSecondary(!0,"editDomainHTTPServerInfo"),i.setParam("hostid",a),d.setAttribute("style","position:absolute;top:"+f+"px;left:"+e+"px;z-index:110;background-color:white;width:400px;height:400px;border-radius:10px;border:1px solid;padding:10px;text-align:center;overflow-y:scroll;"),d.setAttribute("id","divhttpserverinfo"),d.innerHTML=c.getAppController1(),d.innerHTML+='<p>  <input type="button" id="upload" value="Save" onclick="saveHTTPServerData1('+a+",'"+i.getId()+'\');" />  <input type="button" id="cancel" value="Cancel" onclick="cancelHTTPServerData1(\''+i.getId()+"');\" />  </p>",document.body.appendChild(d),i.render()}function createHTTPServerInfoDiv1back(a,b){var c=network.getElement(a),d=c.getApp("HTTPServer"),e=document.createElement("div"),f=document.body.clientWidth/2-200,g=document.body.clientHeight/2-200,h=uitables[b].getParam("primaryuitableid"),i=(uitables[h].getData(),uitables[h]);e.setAttribute("style","position:absolute;top:"+g+"px;left:"+f+"px;z-index:110;background-color:white;width:400px;height:400px;border-radius:10px;border:1px solid;padding:10px;text-align:center;overflow-y:scroll;"),e.setAttribute("id","divhttpserverinfo"),e.innerHTML=d.getAppController1(),e.innerHTML+='<p>  <input type="button" id="upload" value="Save" onclick="saveHTTPServerData1('+a+",'"+i.getId()+'\');" />  <input type="button" id="cancel" value="Cancel" onclick="cancelHTTPServerData1(\''+i.getId()+"');\" />  </p>",document.body.appendChild(e),i.render()}function createHTTPServerInfoDiv2(a,b,c){var d=network.getElement(a),e=d.getApp("HTTPServer"),f=document.createElement("div"),g=document.body.clientWidth/2-200,h=document.body.clientHeight/2-200,i=["File"],j=c,k=new UITable(i,j,"httpfiletable");k.setSecondary(!0,"editFileHTTPServerInfo"),k.setParam("hostid",a),k.setParam("primaryuitableid",b),f.setAttribute("style","position:absolute;top:"+h+"px;left:"+g+"px;z-index:110;background-color:white;width:400px;height:400px;border-radius:10px;border:1px solid;padding:10px;text-align:center;overflow-y:scroll;"),f.setAttribute("id","divhttpfileserverinfo"),f.innerHTML=e.getAppController2(),f.innerHTML+='<p>  <input type="button" id="upload" value="Back" onclick="backHTTPServerData2('+a+",'"+k.getId()+"');\" />  </p>",document.body.appendChild(f),k.render()}function createHTTPServerInfoDiv3(a,b,c){var d=uitables[b].getData(),e=d[c][1],f=network.getElement(a),g=f.getApp("HTTPServer"),h=document.createElement("div"),i=document.body.clientWidth/2-200,j=document.body.clientHeight/2-75;h.setAttribute("style","position:absolute;top:"+j+"px;left:"+i+"px;z-index:110;background-color:white;width:400px;height:150px;border-radius:10px;border:1px solid;padding:10px;text-align:center;"),h.setAttribute("id","divhttpcontentsserverinfo"),h.innerHTML=g.getAppController3(e),h.innerHTML+='<p>  <input type="button" id="upload" value="Back" onclick="backHTTPServerData3('+a+",'"+b+"',"+c+');" />  </p>',document.body.appendChild(h)}function backHTTPServerData3(a,b,c){var d=uitables[b].getData(),e=document.getElementById("httpcontents").value;d[c][1]=e,removeBodyDiv("divhttpcontentsserverinfo");var f=uitables[b].getParam("primaryuitableid");createHTTPServerInfoDiv2(a,f,d)}function editFileHTTPServerInfo(a,b){var c=uitables[a].getParam("hostid"),d=uitables[a].getData();1==d[b].length&&(d[b][1]=""),removeBodyDiv("divhttpfileserverinfo"),createHTTPServerInfoDiv3(c,a,b)}function editDomainHTTPServerInfo(a,b){var c=uitables[a].getParam("hostid"),d=uitables[a].getData();1==d[b].length&&(d[b][1]=[]);var e=d[b][1];removeBodyDiv("divhttpserverinfo"),createHTTPServerInfoDiv2(c,a,e)}function backHTTPServerData2(a,b){removeBodyDiv("divhttpfileserverinfo"),createHTTPServerInfoDiv1back(a,b)}function saveHTTPServerData1(a,b){var c=uitables[b].getData(),d=network.getElement(a),e=d.getApp("HTTPServer");e.resetHTTPServerInfo();for(var f=0;f<c.length;f++){var g=c[f][0];if(e.addDomain(g),c[f].length>1)for(var h=0;h<c[f][1].length;h++){var i=c[f][1][h][0];1===c[f][1][h].length&&(c[f][1][h][1]="");var j=c[f][1][h][1];e.setFileContents(g,i,j)}}removeBodyDiv("divhttpserverinfo"),removeBodyDiv("divbk"),uitables[b].dispose()}function cancelHTTPServerData1(a){removeBodyDiv("divhttpserverinfo"),removeBodyDiv("divbk"),uitables[a].dispose()}function editNameGroup(a){createBkDiv(),createNameGroupDiv(a)}function createNameGroupDiv(a){var b=network.getElement(a),c=document.createElement("div"),d=window.innerWidth/2-200,e=window.innerHeight/2-200;c.setAttribute("style","position:absolute;top:"+e+"px;left:"+d+"px;z-index:110;background-color:white;width:700px;height:400px;border-radius:10px;border:1px solid;padding:10px;text-align:center;"),c.setAttribute("id","divnamegroup");var f="<p>";f+='<label for="nametxt">Name:</label>',f+='<input type="text" id="nametxt" value="'+(null===b.getName()?"":b.getName())+'" /><br/>',f+='<label for="grouptxt">Group:</label>',f+='<input type="text" id="grouptxt" value="'+(null===b.getGroup()?"":b.getGroup())+'" />',f+="</p>",f+="<p>",f+='<p>  <input type="button" id="save" value="Save" onclick="saveNameGroup('+a+');" />  <input type="button" id="cancel" value="Exit" onclick="cancelNameGroup();" />  </p>',c.innerHTML=f,document.body.appendChild(c)}function cancelNameGroup(){removeBodyDiv("divnamegroup"),removeBodyDiv("divbk")}function saveNameGroup(a){var b=network.getElement(a),c=document.getElementById("nametxt").value,d=document.getElementById("grouptxt").value;d=""===d?null:d,b.setName(c),b.setGroup(d),removeBodyDiv("divnamegroup"),removeBodyDiv("divbk")}function networkDiagnostics(a){createBkDiv(),createDiagnosticsDiv(a)}function createDiagnosticsDiv(a){var b=network.getElement(a),c=(document.createElement("div"),"<p>");c+='<select id="ifacepos">';for(var d=0;d<b.getConnectable().getConnectorNumber();d++)c+='<option value="'+d+'">'+b.getConnectorDesc(d)+"</option>";c+="</select>",c+='<input type="text" id="diagnosticstxt" />',c+="</p>",c+="<p>",c+='<input type="button" id="ping" value="Ping" onclick="diagnosticsPing('+a+')" />',c+='<input type="button" id="traceroute" value="Trace Route" onclick="diagnosticsTraceroute('+a+')" />',c+="</p>",c+='<div style="width:100%;height:250px;text-align:left;font-size:0.8em;font-style:italic;" id="diagnosticsconsole" >',c+=b.getConnectable().getTrafficManager().getDiagnosticsInfo(),c+="</div>";var e='<input type="button" id="cancel" value="Exit" onclick="cancelDiagnostics();" />',f=new UIWindow("divdiagnostics","Network diagnostics",400,400,!1,1);f.setContent(c),f.setControls(e),f.render()}function diagnosticsPing(a){var b=network.getElement(a),c=document.getElementById("diagnosticstxt").value,d=document.getElementById("ifacepos").value;b.getConnectable().getTrafficManager().ping(c,d)}function diagnosticsTraceroute(a){var b=network.getElement(a),c=document.getElementById("diagnosticstxt").value,d=document.getElementById("ifacepos").value;b.getConnectable().getTrafficManager().traceroute(c,d)}function cancelDiagnostics(){removeBodyDiv("divbk"),uimanager.getWindow("divdiagnostics").dispose()}function editNATTable(a){createBkDiv(),createNATDiv(a)}function createNATDiv(a){var b=network.getElement(a),c=document.createElement("div"),d=window.innerWidth/2-350,e=window.innerHeight/2-200,f=["Input interface","WAN Port","LAN Port","IP"],g=b.getConnectable().getTrafficManager().getNATData(),h=new UITable(f,g,"nattable");c.setAttribute("style","position:absolute;top:"+e+"px;left:"+d+"px;z-index:110;background-color:white;width:700px;height:400px;border-radius:10px;border:1px solid;padding:10px;text-align:center;"),c.setAttribute("id","divnatconfig");var i="";if("router"===b.getType()){var j=b.getConnectable().getPerformNAT()?"checked='checked'":"";i+="<p>",i+="<input type='checkbox' id='performNAT' "+j+" />",i+="<label for='performNAT'>Gateway mode (uses NAT).</label>",i+="</p>"}i+='<table id="nattable" style="font-size:0.8em;width:100%;"></table>',i+='<p>  <input type="button" id="upload" value="Save" onclick="saveNATConfig('+a+",'"+h.getId()+'\');" />  <input type="button" id="cancel" value="Cancel" onclick="cancelNATConfig(\''+h.getId()+"');\" />  </p>",c.innerHTML=i,document.body.appendChild(c),h.render()}function cancelNATConfig(a){removeBodyDiv("divnatconfig"),removeBodyDiv("divbk"),uitables[a].dispose()}function saveNATConfig(a,b){var c=network.getElement(a);c.getConnectable().getTrafficManager().removeFixedNATData();for(var d=uitables[b].getData(),e=0;e<d.length;e++)c.getConnectable().getTrafficManager().addNATEntry(d[e][2],d[e][1],d[e][3],d[e][0],!0);var f=document.getElementById("performNAT");null!==f&&c.getConnectable().setPerformNAT(f.checked),removeBodyDiv("divnatconfig"),removeBodyDiv("divbk"),uitables[b].dispose()}function editIpInfo(a,b){createBkDiv(),createIpDiv(a,b)}function createIpDiv(a,b){var c=network.getElement(a),d=c.getConnectable(),e=d.getIPInfo(b),f=document.createElement("div"),g=window.innerWidth/2-200,h=window.innerHeight/2-75,i=null!==e.getIPv4()?e.getIPv4():"",j=null!==e.getNetmask()?e.getNetmask():"255.255.255.0",k=null!==e.getDNS1()?e.getDNS1():"",l=null!==e.getDNS2()?e.getDNS2():"";f.setAttribute("style","position:absolute;top:"+h+"px;left:"+g+"px;z-index:110;background-color:white;width:400px;height:150px;border-radius:10px;border:1px solid;padding:10px;text-align:center;"),f.setAttribute("id","divipinfo"),f.innerHTML='<label for="ip">IP Address:</label>',f.innerHTML+='<input id="ip" type="text" value="'+i+'" /><br/>',f.innerHTML+='<label for="nm">Network Mask:</label>',f.innerHTML+='<input id="nm" type="text" value="'+j+'" /><br/>',f.innerHTML+='<label for="dns1">DNS 1:</label>',f.innerHTML+='<input id="dns1" type="text" value="'+k+'" /><br/>',f.innerHTML+='<label for="dns2">DNS 2:</label>',f.innerHTML+='<input id="dns2" type="text" value="'+l+'" /><br/>',f.innerHTML+='<p>  <input type="button" id="upload" value="Save" onclick="saveIpInfo('+a+","+b+');" />  <input type="button" id="cancel" value="Cancel" onclick="cancelIpInfo();" />  </p>',document.body.appendChild(f)}function saveIpInfo(a,b){var c=network.getElement(a),d=document.getElementById("ip").value,e=document.getElementById("nm").value,f=document.getElementById("dns1").value,g=document.getElementById("dns2").value;d=""===d?null:d,e=""===e?null:e,f=""===f?null:f,g=""===g?null:g,c.getConnectable().getIPInfo(b).setIPv4(d),c.getConnectable().getIPInfo(b).setNetmask(e),c.getConnectable().getIPInfo(b).setDNS1(f),c.getConnectable().getIPInfo(b).setDNS2(g),c.getConnectable().getIPInfo(b).setStatic(!0),removeBodyDiv("divipinfo"),removeBodyDiv("divbk")}function cancelIpInfo(){removeBodyDiv("divipinfo"),removeBodyDiv("divbk")}function isValidIPv4(a){var b=!1;if(null!==a){var c=a.split(".");if(4===c.length){var d=parseInt(c[0]),e=parseInt(c[1]),f=parseInt(c[2]),g=parseInt(c[3]);b=0/0!==d&&d>=0&&255>=d&&0/0!==e&&e>=0&&255>=e&&0/0!==f&&f>=0&&255>=f&&0/0!==g&&g>=0&&255>=g}}else b=!0;return b}function ipStringToInt(a){var b=null;if(null!==a){var c=a.split(".");b=c[0]<<24|c[1]<<16|c[2]<<8|c[3]}return b}function ipIntToString(a){if(result=null,null!==a){var b=255&a,c=a>>8&255,d=a>>16&255,e=a>>24&255;result=e+"."+d+"."+c+"."+b}return result}function selectLinkConnectors(a,b){createBkDiv(),createLinkConnectorsDiv(a,b)}function getElementConnectorsSelectables(a){for(var b="",c=0;c<a.getConnectable().getConnectorNumber();c++){var d=a.getConnectable().getConnector(c),e=d.isConnected()?" disabled='disabled' ":"";b+="<input type='radio' name='link_host_"+a.id+"' value='"+c+"' id='link_host_"+a.id+"_"+c+"' "+e+"/>",b+=a.getConnectorDesc(c),b+="<br/>"}return b}function createLinkConnectorsDiv(a,b){var c=network.getElement(a),d=network.getElement(b),e=document.createElement("div"),f=window.innerWidth/2-200,g=window.innerHeight/2-200;e.setAttribute("style","position:absolute;top:"+g+"px;left:"+f+"px;z-index:110;background-color:white;width:400px;height:400px;border-radius:10px;border:1px solid;padding:10px;text-align:center;"),e.setAttribute("id","divlinkconnectors");var h='<table style="font-size:0.8em;">';h+="<tr><th>"+c.getName()+"</th><th>"+d.getName()+"</th></tr>",h+="<tr>",h+="<td>",h+=getElementConnectorsSelectables(c),h+="</td>",h+="<td>",h+=getElementConnectorsSelectables(d),h+="</td>",h+="</tr>",h+="</table>",h+='<p>  <input type="button" id="upload" value="Save" onclick="saveLinkConnectors('+a+","+b+');" />  <input type="button" id="cancel" value="Cancel" onclick="cancelLinkConnectors();" />  </p>',e.innerHTML=h,document.body.appendChild(e)}function saveLinkConnectors(a,b){var c=document.querySelector('input[name="link_host_'+a+'"]:checked'),d=document.querySelector('input[name="link_host_'+b+'"]:checked');if(null!==c&&null!==d){var e=c.value,f=d.value;null!==e&&null!==f&&(network.createLink(a,e,b,f),removeBodyDiv("divlinkconnectors"),removeBodyDiv("divbk"))}}function cancelLinkConnectors(){removeBodyDiv("divlinkconnectors"),removeBodyDiv("divbk")}function getNextMessageId(){return++lastMessageId}function deleteSelected(){null!==network.getSelected()&&network.getSelected()instanceof Host?confirm("Do you really want to delete the selected element?")&&(network.deleteSelectedElement(),uimanager.selectedElementDeleted()):null!==network.getSelected()&&network.getSelected()instanceof Link&&confirm("Do you really want to delete the selected link?")&&(network.deleteSelectedLink(),uimanager.selectedLineDeleted())}function UIClickable(a,b,c){var a=a,b=b,c=c;this.isInCoords=function(){alert("This function needs to be redefined - isInCoords")},this.performAction=function(){null!==a&&a(b)},this.getObject=function(){return c}}function sqr(a){return a*a}function dist2(a,b){return sqr(a.x-b.x)+sqr(a.y-b.y)}function distToSegmentSquared(a,b,c){var d=dist2(b,c);if(0==d)return dist2(a,b);var e=((a.x-b.x)*(c.x-b.x)+(a.y-b.y)*(c.y-b.y))/d;return 0>e?dist2(a,b):e>1?dist2(a,c):dist2(a,{x:b.x+e*(c.x-b.x),y:b.y+e*(c.y-b.y)})}function distToSegment(a,b,c){return Math.sqrt(distToSegmentSquared(a,b,c))}function UILine(a,b,c,d,e,f,g,h){UIClickable.call(this,a,b,c),this.X1=d,this.Y1=e,this.X2=f,this.Y2=g,this.Z=h,this.setCoords=function(a,b,c,d,e){this.X1=a,this.Y1=b,this.X2=c,this.Y2=d,this.Z=e},this.isInCoords=function(a,b){return distToSegment({x:a,y:b},{x:this.X1,y:this.Y1},{x:this.X2,y:this.Y2})<LINE_SELECT_TOLERANCE}}function createLinkAction(){uimanager.createLinkAction()}function createBkDiv(){var a=document.createElement("div"),b=document.body.scrollWidth,c=document.body.scrollHeight;a.setAttribute("style","position:absolute;top:0;left:0;z-index:100;background-color:white;width:"+b+"px;height:"+c+"px;opacity:0.25;"),a.setAttribute("id","divbk"),document.body.appendChild(a)}function saveNetwork(){var a=document.createElement("a");a.setAttribute("href","data:text/plain;charset:utf-8,"+encodeURIComponent(network.save())),a.setAttribute("download","network.json"),document.body.appendChild(a),a.click(),document.body.removeChild(a)}function removeBodyDiv(a){var b=document.getElementById(a);document.body.removeChild(b)}function cancelUpload(){removeBodyDiv("divupload"),removeBodyDiv("divbk")}function confirmUpload(){var a=document.getElementById("uploaddata"),b=a.files[0],c=new FileReader;c.onload=function(a){var b=JSON.parse(a.target.result);network.load(b)},c.readAsText(b),removeBodyDiv("divupload"),removeBodyDiv("divbk")}function createUploadDiv(){var a=document.createElement("div"),b=(window,window.innerWidth/2-200),c=window.innerHeight/2-75;a.setAttribute("style","position:absolute;top:"+c+"px;left:"+b+"px;z-index:110;background-color:white;width:400px;height:150px;border-radius:10px;border:1px solid;padding:10px;text-align:center;"),a.setAttribute("id","divupload"),a.innerHTML='<p><input type="file" id="uploaddata" name="uploaddata" /></p>  <p>  <input type="button" id="upload" value="Upload" onclick="confirmUpload();" />  <input type="button" id="cancel" value="Cancel" onclick="cancelUpload();" />  </p>',document.body.appendChild(a)}function uploadClick(){createBkDiv(),createUploadDiv()}function UIRectangle(a,b,c,d,e,f,g,h,i){UIClickable.call(this,a,b,c),this.X=d,this.Y=e,this.W=f,this.H=g,this.Z=h;var i=i;this.setCoords=function(a,b,c,d,e){this.X=a,this.Y=b,this.W=c,this.H=d,this.Z=e},this.isInCoords=function(a,b){return i&&(a-=document.body.scrollLeft,b-=document.body.scrollTop),this.X<=a&&a<=this.X+this.W&&this.Y<b&&b<this.Y+this.H}}function getNextTableID(){return++lasttableid}function deleteUITableRow(a,b){uitables[a].deleteRow(b)}function addUITableRow(a){uitables[a].addRow()}function newElement(a){switch(a){case"host":network.createComputer(0,50);break;case"dns":network.createDNSServer(0,50);break;case"dhcp":network.createDHCPServer(0,50);break;case"web":network.createHTTPServer(0,50);break;case"switch":network.createSwitch(0,50,8);break;case"router":network.createRouter(0,50)}}function simulator(a){images=a;var b=document.getElementById("simcontainer"),c=document.getElementById("simcanvas"),d=b.offsetWidth*window.devicePixelRatio,e=b.offsetHeight*window.devicePixelRatio;c.width=d,c.height=e;var f=c.getContext("2d",{antialias:!0});uimanager=new UIManager,network=new Network(images,f,d,e),network.init(),null!==NetworkSimulator.initialdata&&network.load(NetworkSimulator.initialdata)}var Connectable=function(a,b,c,d,e){function f(){for(var a="0123456789ABCDEF",b="",c=0;12>c;c++)b+=a.charAt(Math.floor(Math.random()*a.length)),c%2==1&&11!==c&&(b+=":");j.push(b)}function g(){k.push(new IPInfo)}function h(){l=new TrafficManager(p,d,e),o=new GatewayManager(p),b===MACMODE_SHARED&&f(),c===IPMODE_SHARED&&g()}this.id=getNextID();var i=[],j=[],k=[],b=b,c=c,l=null,m=[],n=[],e=e,o=null,p=this,q=a;this.save=function(){var a={};a.version=1,a.id=this.id,a.connectors=[],a.macaddresses=[],a.ipinfos=[],a.macmode=b,a.ipmode=c,a.trafficManager=l.save(),a.gateways=o.save(),a.performNAT=e;for(var d=0;d<i.length;d++)a.connectors.push(i[d].save());a.macaddresses=j;for(var d=0;d<k.length;d++)a.ipinfos.push(k[d].save());return a},this.load=function(a){this.id=a.id;for(var d=0;d<a.connectors.length;d++)i[d].load(a.connectors[d]);j=a.macaddresses;for(var d=0;d<a.ipinfos.length;d++)k[d].load(a.ipinfos[d]);b=a.macmode,c=a.ipmode,"undefined"!=typeof a.performNAT&&this.setPerformNAT(a.performNAT),l.load(a.trafficManager),o.load(a.gateways?a.gateways:null)},this.updateAddressing=function(a,b){n[a]=b},this.isInMyNetworks=function(a){for(var b=!1,c=0;b===!1&&c<i.length;)b=this.getIPInfo(c).sameNetwork(a),c++;return b},this.getDstMAC=function(a){var b=null;return b="255.255.255.255"==a?"FF:FF:FF:FF:FF:FF":this.isInMyNetworks(a)?this.findMACforIP(a,null):this.findMACforIP(o.getGatewayForIP(a,null))},this.findMACforIP=function(a,b){for(var c=null,d=0;null===c&&d<i.length;){if(i[d]!==b){var e=i[d].getConnectedConnector();if(null!==e){var f=e.getIPInfo();(null===f||f.sameNetwork(a))&&(c=e.whoHas(a),null!==c&&(m[a]=c,n[c]=d))}}d++}return c},this.getTrafficManager=function(){return l},this.getGatewayManager=function(){return o},this.addConnector=function(a){i.push(a),b===MACMODE_UNIQUE&&f(),c===IPMODE_UNIQUE&&g()},this.removeConnector=function(a){i.slice(a,1)},this.getConnector=function(a){return i[a]},this.getConnectorNumber=function(){return i.length},this.getOwner=function(){return q},this.getMAC=function(a){var c=null;return a<j.length&&(b===MACMODE_SHARED&&(a=0),c=j[a]),c},this.getIPInfo=function(a){var b=null;return a<k.length&&(c===IPMODE_SHARED&&(a=0),b=k[a]),b},this.getFirstFreeConnector=function(){for(var a=!1,b=0;a===!1&&b<i.length;)i[b].isConnected()?b++:a=i[b];return a},this.compatibleIP=function(a,b){var c=b&&this.compatibleBroadcastIP(a);if(!c)for(var d=0;!c&&d<k.length;)c=k[d].getIPv4()===a,d++;return c},this.compatibleBroadcastIP=function(a){return"255.255.255.255"===a},this.compatibleMAC=function(a,b){var c=b&&this.compatibleBroadcastMAC(a);if(!c)for(var d=0;!c&&d<j.length;)c=j[d]===a,d++;return c},this.compatibleBroadcastMAC=function(a){return"FF:FF:FF:FF:FF:FF"===a},this.getConnectorPos=function(a){return i.indexOf(a)},this.getIpMode=function(){return c},this.getSenderConnectorForMAC=function(a){var b=null;return a in n&&(b=i[n[a]]),b},this.findConnector=function(a){for(var b=null,c=0;null===b&&c<i.length;)i[c].id===a&&(b=i[c]),c++;return b},this.getPerformNAT=function(){return e},this.setPerformNAT=function(a){e=a,l.setPerformNAT(a)},h()},Connector=function(a){function b(){a.addConnector(d)}this.id=getNextID();var a=a,c=null,d=this;this.save=function(){var a={};return a.version=1,a.id=this.id,a},this.load=function(a){this.id=a.id},this.setLink=function(a){c=a},this.getLink=function(){return c},this.send=function(a){null!=c&&c.addMessage(d,a)},this.receive=function(b){a.getTrafficManager().proccess(this,b)},this.getConnectable=function(){return a},this.isConnected=function(){return null!==c},this.getConnectedConnector=function(){var a=null;return this.isConnected()&&(a=c.getConnector1()!==this?c.getConnector1():c.getConnector2()),a},this.getDescription=function(){var b="",c=a.getConnectorPos(this);"router"===a.getOwner().getType()&&(b+=c===ROUTER_LAN?"LAN":"WAN",b+=": ");var d=a.getIPInfo(c);return null!==d&&null!==d.getIPv4()&&(b+=d.getIPv4()),b},this.whoHas=function(b){var c=null,d=a.getConnectorPos(this),e=a.getIPInfo(d);return c=null!==e&&e.getIPv4()===b?a.getMAC(d):a.findMACforIP(b,this)},this.getIPInfo=function(){var b=null;switch(a.getIpMode()){case IPMODE_NOIP:b=null;break;case IPMODE_UNIQUE:var c=a.getConnectorPos(this);b=a.getIPInfo(c);break;case IPMODE_SHARED:b=a.getIPInfo(0)}return b},b()},DHCPClient=function(a){var b=null,a=a;this.save=function(){var b={};return b.version=1,b.id=this.getId(),b.ifacepos=a,b},this.load=function(){},this.getId=function(){return"DHCPClient"},this.requestInfo=function(){var c={};c.type="request",c.description="DHCP: request";var d=new Message("tcp",b.getConnectable().getIPInfo(a).getIPv4(),"255.255.255.255",b.getConnectable().getMAC(a),"FF:FF:FF:FF:FF:FF",getDinamycPort(),67,c,images[IMAGE_ENVELOPEDHCP]);b.getConnectable().getTrafficManager().registerApplication(this,d.getOrigPort(),!1),b.getConnectable().getConnector(a).send(d)},this.receiveMessage=function(c){b.getConnectable().getIPInfo(a).setIPv4(c.getData().ipv4),b.getConnectable().getIPInfo(a).setDNS1(c.getData().dns1),b.getConnectable().getIPInfo(a).setDNS2(c.getData().dns2),b.getConnectable().getGatewayManager().addGatewayInfo("0.0.0.0","0.0.0.0",c.getData().gateway),b.getConnectable().getIPInfo(a).setNetmask(c.getData().netmask),b.getConnectable().getIPInfo(a).setStatic(!1)},this.setOwner=function(a){b=a},this.getIfacepos=function(){return a},this.getMenuEntries=function(){var a=[];return a[0]={},a[0].img="img/64/envelope-DHCP.png",a[0].text="Request DHCP info",a[0].js="requestDHCPInfoCommand("+b.id+");",a}},DHCPServer=function(a){function b(b){for(var c=e,f=!1;!f;)c in j?c++:f=!0;var g=d.getConnectable().getIPInfo(a).getIPv4().split("."),h=g[0]+"."+g[1]+"."+g[2]+".",i={};return i.mac=b,i.ipv4=h+c,j[c]=i,k[b]=i,c}function c(a){var b=null;return a in k&&(b=j.indexOf(k[a])),b}var d=null,a=a,e=100,f=200,g=null,h=null,i=null,j=[],k=[];this.save=function(){var b={};return b.version=1,b.id=this.getId(),b.ifacepos=a,b.initial=e,b.end=f,b.gateway=g,b.dns1=h,b.dns2=i,b},this.load=function(a){e=a.initial,f=a.end,g=a.gateway,h=a.dns1,i=a.dns2},this.getId=function(){return"DHCPServer"},this.setData=function(a,b,c,d,j){e=a,f=b,g=c,h=d,i=j},this.receiveMessage=function(e){if("request"===e.getData().type){var f=c(e.getOriginMAC());null===f&&(f=b(e.getOriginMAC()));var k={};k.ipv4=j[f].ipv4,k.dns1=h,k.dns2=i,k.gateway=g,k.netmask=d.getConnectable().getIPInfo(a).getNetmask(),k.description="DHCP: offer";var l=new Message("tcp",d.getConnectable().getIPInfo(a).getIPv4(),j[f].ipv4,d.getConnectable().getMAC(a),e.getOriginMAC(),67,e.getOrigPort(),k,images[IMAGE_ENVELOPEDHCP]);d.getConnectable().getConnector(a).send(l)}},this.setOwner=function(a){d=a},this.getIfacepos=function(){return a},this.getAppController=function(){network.getPosForElement(d);return result="<label for='dhcpinitial'>Initial:</label>     <input type='text' id='dhcpinitial' value='"+e+"' /><br/>     <label for='dhcpend'>Final:</label>     <input type='text' id='dhcpend' value='"+f+"' /><br/>     <label for='dhcpgw'>Gateway:</label>     <input type='text' id='dhcpgw' value='"+(null===g?"":g)+"' /><br/>     <label for='dhcpdns1'>DNS 1:</label>     <input type='text' id='dhcpdns1' value='"+(null===h?"":h)+"' /><br/>     <label for='dhcpdns2'>DNS 2:</label>     <input type='text' id='dhcpdns2' value='"+(null===i?"":i)+"' /><br/>     ",result},this.getMenuEntries=function(){var a=[];return a[0]={},a[0].img="img/64/envelope-DHCP.png",a[0].text="Edit DHCP server info",a[0].js="editDHCPServerInfo("+d.id+");",a}},DNSClient=function(a){var b=null,a=a,c=[];this.save=function(){var b={};return b.version=1,b.id=this.getId(),b.ifacepos=a,b},this.load=function(){},this.getId=function(){return"DNSClient"},this.DNSLookup=function(c){var d=b.getConnectable().getDstMAC(b.getConnectable().getIPInfo(a).getDNS1());if(null!==d){var e={};e.domain=c,e.type="lookup",e.description="Lookup: "+c;var f=new Message("tcp",b.getConnectable().getIPInfo(a).getIPv4(),b.getConnectable().getIPInfo(a).getDNS1(),b.getConnectable().getMAC(a),d,getDinamycPort(),53,e,images[IMAGE_ENVELOPEDNS]);b.getConnectable().getTrafficManager().registerApplication(this,f.getOrigPort(),!1),b.getConnectable().getConnector(a).send(f)}},this.receiveMessage=function(a){null!==a.getData().ip&&(c[a.getData().domain]=a.getData().ip)},this.setOwner=function(a){b=a},this.getIfacepos=function(){return a},this.getIp=function(a){var b=null;return a in c&&(b=c[a]),b},this.getAppController=function(){var a=(network.getPosForElement(b),"<p>         <label for='dnsclientdomain' >Domain:</label>         <input type='text' id='dnsclientdomain' />         </p>");return a},this.getMenuEntries=function(){var a=[];return a[0]={},a[0].img="img/64/envelope-DNS.png",a[0].text="DNS lookup",a[0].js="createDNSLookup("+b.id+");",a}},DNSServer=function(a){function b(b){var c=f.getConnectable().getDstMAC(h);if(null!==c){var d={};d.domain=b.getData().domain,d.type="lookup_forward",d.description="Lookup Fwd: "+b.getData().domain,d.originId=b.getId();var e=new Message("tcp",f.getConnectable().getIPInfo(a).getIPv4(),h,f.getConnectable().getMAC(a),c,getDinamycPort(),53,d,images[IMAGE_ENVELOPEDNS]);
i[e.getId()]={},i[e.getId()].domain=b.getData().domain,i[e.getId()].ip=b.getOriginIP(),i[e.getId()].port=b.getOrigPort(),i[e.getId()].originId=b.getId(),f.getConnectable().getTrafficManager().registerApplication(j,e.getOrigPort(),!1),f.getConnectable().getConnector(a).send(e)}}function c(c){var d=!1,e={};if(e.domain=c.getData().domain,e.type="response",e.domain in g?(e.ip=g[e.domain],e.description="Response: "+e.ip,d=!0):null!==h?b(c):(e.ip=null,e.description="Response: not found",d=!0),d){var i=new Message("tcp",f.getConnectable().getIPInfo(a).getIPv4(),c.getOriginIP(),f.getConnectable().getMAC(a),f.getConnectable().getDstMAC(c.getOriginIP()),53,c.getOrigPort(),e,images[IMAGE_ENVELOPEDNS]);f.getConnectable().getConnector(a).send(i)}}function d(c){var d=!1,e={};if(e.domain=c.getData().domain,e.type="response_forward",e.originId=c.getId(),e.domain in g?(e.ip=g[e.domain],e.description="Response Fwd: "+e.ip,d=!0):null!==h?b(c):(e.ip=null,e.description="Response Fwd: not found",d=!0),d){var i=new Message("tcp",f.getConnectable().getIPInfo(a).getIPv4(),c.getOriginIP(),f.getConnectable().getMAC(a),f.getConnectable().getDstMAC(c.getOriginIP()),53,c.getOrigPort(),e,images[IMAGE_ENVELOPEDNS]);f.getConnectable().getConnector(a).send(i)}}function e(b){if(b.getData().originId in i){var c={};c.domain=b.getData().domain,c.type="response_forward",c.originId=i[b.getData().originId].originId,null!==c.domain?(c.ip=b.getData().ip,c.description="Response Fwd: "+c.ip):(c.ip=null,c.description="Response Fwd: not found");var d=new Message("tcp",f.getConnectable().getIPInfo(a).getIPv4(),i[b.getData().originId].ip,f.getConnectable().getMAC(a),f.getConnectable().getDstMAC(i[b.getData().originId].ip),53,i[b.getData().originId].port,c,images[IMAGE_ENVELOPEDNS]);delete i[b.getData().originId],f.getConnectable().getConnector(a).send(d)}}var f=null,a=a,g=[],h=null,i=[],j=this;this.save=function(){var b={};b.version=1,b.id=this.getId(),b.ifacepos=a,b.dnstable=[],b.forwarder=h;for(var c in g){var d={};d.domain=c,d.ip=g[c],b.dnstable.push(d)}return b},this.load=function(a){a.forwarder&&(h=a.forwarder);for(var b=0;b<a.dnstable.length;b++)this.setEntry(a.dnstable[b].domain,a.dnstable[b].ip)},this.getId=function(){return"DNSServer"},this.getPort=function(){return port},this.resetDNSTable=function(){g=[]},this.setEntry=function(a,b){g[a]=b},this.deleteDNSEntry=function(a){a in g&&delete g[a]},this.receiveMessage=function(a){"lookup"===a.getData().type&&a.getData().domain?c(a):"lookup_forward"===a.getData().type&&a.getData().domain?d(a):"response_forward"===a.getData().type&&e(a)},this.setOwner=function(a){f=a},this.getIfacepos=function(){return a},this.getAppController=function(){network.getPosForElement(f);result="<table id='dnstable' style='font-size:0.8em;'></table>",result+="<p>",result+="<label for='forwarder'>Forwarder:</label>";var a=null===h?"":h;return result+="<input type='text' id='forwarder' value='"+a+"' />",result+="</p>",result},this.getMenuEntries=function(){var a=[];return a[0]={},a[0].img="img/64/envelope-DNS.png",a[0].text="DNS server config",a[0].js="setupDNSServerConfig("+f.id+");",a},this.getAppControllerData=function(){var a=[];for(var b in g){var c=[];c.push(b),c.push(g[b]),a.push(c)}return a},this.setForwarder=function(a){h=a}},Drawable=function(a){function b(a){var b=8;a.font="8pt",a.fillStyle="black";for(var c=g.getStrInfo().split("\n"),d=0;d<c.length;d++)a.fillText(c[d],0,f.height+b),b+=8}function c(){if(null!==f)for(var a=0;a<i.length;a++)i[a].drawableChanged()}this.id=getNextID();var d=0,e=0,f=null,g=a,h=new UIRectangle(null,null,this,0,0,0,0,0,!1);uimanager.addClickable(h);var i=[];this.save=function(){var a={};return a.version=1,a.id=this.id,a.X=d,a.Y=e,a},this.load=function(a){d=a.X,e=a.Y,this.id=a.id,c()},this.setPosition=function(a,b){d=a,e=b,null!==f&&h.setCoords(d,e,f.width,f.height,0),c()},this.getX=function(){return d},this.getY=function(){return e},this.getCenterX=function(){return d+f.width/2},this.getCenterY=function(){return e+f.height/2},this.setImage=function(a){f=a,null!==f&&h.setCoords(d,e,f.width,f.height,0),c()},this.draw=function(a){a.save(),a.translate(d,e),a.drawImage(f,0,0),b(a),a.restore()},this.getOwner=function(){return g},this.getRect=function(){var a={};return a.x=d,a.y=e,a.width=f.width,a.height=f.height,a},this.addObserver=function(a){i.push(a)},this.deleteObserver=function(a){var b=i.indexOf(a);i.splice(b,1)},this.dispose=function(){uimanager.removeClickable(h)}},GatewayManager=function(a){function b(){d.addGatewayInfo("0.0.0.0","0.0.0.0",null)}var c=[],d=this,e=null;this.addGatewayInfo=function(a,b,d){if(isValidIPv4(a)&&(null===d||isValidIPv4(d))){var f="0.0.0.0"===a,g={};g.dst=a,g.gw=d,f?(g.mask="0.0.0.0",e=g):(g.mask=b,c.push(g))}},this.save=function(){var a={};return a.defaultgw=e.gw,a.gateways=c,a},this.load=function(a){if(null!==a){this.addGatewayInfo("0.0.0.0","0.0.0.0",a.defaultgw);for(var b=0;b<a.gateways.length;b++)this.addGatewayInfo(a.gateways[b].dst,a.gateways[b].mask?a.gateways[b].mask:"255.255.255.0",a.gateways[b].gw)}},this.purgeGatewayInfo=function(){c=[],e.gw=null},this.getController=function(){var a="<table style='width:100%;' id='gwtable'></table>";return a},this.getControllerData=function(){var a=[],b=[];null!==e.gw&&(b[0]=e.dst,b[1]=e.mask,b[2]=e.gw,a.push(b));for(var d=0;d<c.length;d++){var f=[];f[0]=c[d].dst,f[1]=c[d].mask,f[2]=c[d].gw,a.push(f)}return a},this.getGatewayForIP=function(a){var b=null;if(isValidIPv4(a)){for(var d=ipStringToInt(a),f=0;null===b&&f<c.length;){var g=ipStringToInt(c[f].dst),h=ipStringToInt(c[f].mask),i=g&h,j=d&h;i===j?b=c[f].gw:f++}null===b&&(b=e.gw)}return b},b()},MACMODE_SHARED=0,MACMODE_UNIQUE=1,IPMODE_SHARED=0,IPMODE_UNIQUE=1,IPMODE_NOIP=2,IMAGE_SWITCH=0,IMAGE_ROUTER=1,IMAGE_COMPUTER=2,IMAGE_SERVERWEB=3,IMAGE_SERVERDNS=4,IMAGE_SERVERDHCP=5,IMAGE_ENVELOPEDHCP=6,IMAGE_ENVELOPEDNS=7,IMAGE_ENVELOPEHTTP=8,IMAGE_ENVELOPEICMP=9,REFRESH_INTERVAL=1e3/60,MSG_ADVANCE=2,LINE_SELECT_TOLERANCE=2,ROUTER_WAN=0,ROUTER_LAN=1,network=null,images=null,uimanager=null,lastuseddinamycport=1024,lastusedid=0,NetworkSimulator={initialdata:null},HTTPClient=function(a){function b(){var a=document.getElementById("httpbrowsercontents");null!==a&&(a.innerHTML=h.getBrowserContents())}function c(c,f,g){e=0,b();var i=d.getConnectable().getDstMAC(f);if(null!==i){var j={};j.domain=c,j.filename=g,j.ip=f,j.description="GET: "+g;var k=new Message("tcp",d.getConnectable().getIPInfo(a).getIPv4(),f,d.getConnectable().getMAC(a),i,getDinamycPort(),80,j,images[IMAGE_ENVELOPEHTTP]);d.getConnectable().getTrafficManager().registerApplication(h,k.getOrigPort(),!1),d.getConnectable().getConnector(a).send(k)}}var d=null,a=a,e=null,f=null,g=null,h=this;this.save=function(){var b={};return b.version=1,b.id=this.getId(),b.ifacepos=a,b},this.load=function(){},this.setOwner=function(a){d=a},this.getOwner=function(){return d},this.getIfacepos=function(){return a},this.getId=function(){return"HTTPClient"},this.resetHTTPServerInfo=function(){domains=[]},this.getMenuEntries=function(){var a=[];return a[0]={},a[0].img="img/64/envelope-HTTP.png",a[0].text="Web browser (HTTP client)",a[0].js="viewWebBrowser("+d.id+");",a},this.getBrowserContents=function(){var a="";switch(e){case 0:a="Loading...";break;case 404:a="404 - Not found";break;case 200:a=f;break;case 997:a="Malformed URL.\n\nUse only 'domain_or_ip/filename.html'.";break;case 998:a="DNS client not present.";break;case 999:a="Domain not in local DNS cache. Look up first.\n\nIf you already performed a lookup, the domain does not exist."}return a=a.replace(/\n/g,"<br/>")},this.getAppController=function(){return result="<p>",result+="<input type='text' id='httpclienturl' style='width:80%;' value='"+(null!==g?g:"")+"' /> ",result+="<a href='#' onclick='requestHTTPWebSite(\""+d.id+"\");'>",result+="<img src='img/64/right-arrow.png' style='height:1em;' />",result+="</a>",result+="</p>",result+="<div id='httpbrowsercontents' style='font-style:italic;overflow:scroll;text-align:left;min-height:300px;'>",result+=this.getBrowserContents(),result+="</div>",result},this.requestHTTPWebSite=function(a){var a=document.getElementById("httpclienturl").value;g=a;var f=a.split("/",2);if(2===f.length){var h=null,i=f[0];if(isValidIPv4(i))h=f[0],c(h,h,f[1]);else{var j=d.getApp("DNSClient");if(null===j)e=998,b();else{var h=j.getIp(i);null===h?(e=999,b()):c(i,h,f[1])}}}else e=997,b()},this.receiveMessage=function(a){e=a.getData().code,f=a.getData().contents,b()}},HTTPServer=function(a){var b=null,a=a,c=[];this.save=function(){var b={};b.version=1,b.id=this.getId(),b.ifacepos=a,b.domains=[];for(domain in c){var d={};d.domain=domain,d.files=[];for(filename in c[domain]){var e={};e.filename=filename,e.contents=c[domain][filename],d.files.push(e)}b.domains.push(d)}return b},this.load=function(a){for(var b=0;b<a.domains.length;b++){var c=a.domains[b].domain;this.addDomain(c);for(var d=0;d<a.domains[b].files.length;d++){var e=a.domains[b].files[d].filename,f=a.domains[b].files[d].contents;this.setFileContents(c,e,f)}}},this.setOwner=function(a){b=a},this.getOwner=function(){return b},this.getIfacepos=function(){return a},this.getId=function(){return"HTTPServer"},this.addDomain=function(a){a in c||(c[a]=[])},this.deleteDomain=function(a){a in c&&delete c[a]},this.setFileContents=function(a,b,d){a in c&&(c[a][b]=d)},this.deleteFile=function(a,b){a in c&&file in c[a]&&delete c[a][b]},this.resetHTTPServerInfo=function(){c=[]},this.getMenuEntries=function(){var a=[];return a[0]={},a[0].img="img/64/envelope-HTTP.png",a[0].text="Edit HTTP server info",a[0].js="editHTTPServerInfo("+b.id+");",a},this.getAppController1=function(){return result="<table id='httptable' style='font-size:0.8em;'></table>",result},this.getAppController2=function(){return result="<table id='httpfiletable' style='font-size:0.8em;'></table>",result},this.getAppController3=function(a){return result="<textarea id='httpcontents' style='font-size:0.8em;width:100%;height:100px;'>",result+=a,result+="</textarea>",result},this.getAppControllerData1=function(){var a=[];for(var b in c){var d=[];d.push(b);var e=[];for(var f in c[b]){var g=[];g[0]=f,g[1]=c[b][f],e.push(g)}d.push(e),a.push(d)}return a},this.receiveMessage=function(d){var e=d.getData(),f=e.domain,g=e.filename,h=(e.ip,null),i=null;if(f in c)g in c[f]?(h=200,i=c[f][g]):(h=404,i="");else if(isValidIPv4(f)){var j=Object.keys(c);j.length>0&&g in c[j[0]]?(h=200,i=c[j[0]][g]):(h=404,i="")}else h=404,i="";var k={};k.code=h,k.contents=i,k.description=h+"-"+g;var l=new Message("tcp",b.getConnectable().getIPInfo(a).getIPv4(),d.getOriginIP(),b.getConnectable().getMAC(a),b.getConnectable().getDstMAC(d.getOriginIP()),80,d.getOrigPort(),k,images[IMAGE_ENVELOPEHTTP]);b.getConnectable().getConnector(a).send(l)}},Host=function(type,ports){function init(){switch(type){case"router":connectable=new Connectable(_self,MACMODE_UNIQUE,IPMODE_UNIQUE,!0,!0);break;case"switch":connectable=new Connectable(_self,MACMODE_SHARED,IPMODE_NOIP,!1,!1);break;default:connectable=new Connectable(_self,MACMODE_UNIQUE,IPMODE_UNIQUE,!0,!1)}for(var a=0;ports>a;a++){new Connector(connectable)}drawable=new Drawable(_self),drawable.addObserver(_self),menu=new UIMenu(name,0,0,!1),addStaticMenu(),uimanager.addMenu(menu)}function addStaticMenu(){if(menu.addEntry("img/64/delete.png","Delete element","deleteSelected();"),menu.addEntry("img/64/edit.png","Edit Name / Group","editNameGroup("+_self.id+");"),menu.addEntry("img/64/link.png","Create Link","createLinkAction();"),connectable.getIpMode()!==IPMODE_NOIP&&(menu.addEntry("img/64/inspect.png","Network diagnostics","networkDiagnostics("+_self.id+");"),menu.addEntry("img/64/edit.png","Edit Gateways","editGateways("+_self.id+");")),connectable.getIpMode()===IPMODE_UNIQUE)for(var a=0;a<connectable.getConnectorNumber();a++)menu.addEntry("img/64/edit.png","Edit IP Info - "+_self.getConnectorDesc(a),"editIpInfo("+_self.id+","+a+");");"router"===type&&menu.addEntry("img/64/edit.png","Edit NAT table","editNATTable("+_self.id+");")}function redoMenu(){menu.purge(),menu.setDescription(name),addStaticMenu();for(var a in apps)for(var b=apps[a],c=b.app.getMenuEntries(),d=0;d<c.length;d++)menu.addEntry(c[d].img,c[d].text,c[d].js)}this.id=getNextID();var type=type,connectable=null,drawable=null,_self=this,ports=ports,menu=null,name=type+" "+this.id,group=null,apps=[];this.save=function(){var a={};a.version=1,a.id=this.id,a.type=type,a.drawable=drawable.save(),a.connectable=connectable.save(),a.ports=ports,a.apps=[],a.name=name,a.group=group;for(var b in apps){var c={};c.app=apps[b].app.save(),c.port=apps[b].port,c.fixed=apps[b].fixed,c.type=b,c.ifacepos=apps[b].app.getIfacepos(),a.apps.push(c)}return a},this.load=function(data){switch(this.id=data.id,type=data.type,drawable.load(data.drawable),type){case"computer":drawable.setImage(network.getImages()[IMAGE_COMPUTER]);break;case"dhcpserver":drawable.setImage(network.getImages()[IMAGE_SERVERDHCP]);break;case"dnsserver":drawable.setImage(network.getImages()[IMAGE_SERVERDNS]);break;case"httpserver":drawable.setImage(network.getImages()[IMAGE_SERVERWEB]);break;case"router":drawable.setImage(network.getImages()[IMAGE_ROUTER]);break;case"switch":drawable.setImage(network.getImages()[IMAGE_SWITCH])}if(connectable.load(data.connectable),data.apps)for(var i=0;i<data.apps.length;i++){var app=eval("new "+data.apps[i].type+"("+data.apps[i].ifacepos+")");app.load(data.apps[i].app),this.addApp(app,data.apps[i].port,data.apps[i].fixed)}data.name&&this.setName(data.name),data.group&&(group=data.group),redoMenu()},this.setName=function(a){name=a,redoMenu()},this.setGroup=function(a){group=a},this.getName=function(){return name},this.getGroup=function(){return group},this.getConnectorDesc=function(a){var b="Interface "+a;return"router"===type&&(b=a===ROUTER_WAN?"WAN":"LAN"),b},this.drawableChanged=function(){var a=drawable.getRect();menu.setPos(a.x+a.width,a.y)},this.addApp=function(a,b,c){apps[a.getId()]={},apps[a.getId()].app=a,apps[a.getId()].port=b,apps[a.getId()].fixed=c,a.setOwner(_self),c&&connectable.getTrafficManager().registerApplication(a,b,!0),redoMenu()},this.getAppNames=function(){return Object.keys(apps)},this.getApp=function(a){var b=null;return a in apps&&(b=apps[a].app),b},this.getConnectable=function(){return connectable},this.getDrawable=function(){return drawable},this.getType=function(){return type},this.getStrInfo=function(){if(result=name,connectable.getIpMode()===IPMODE_UNIQUE)for(var a=0;a<connectable.getConnectorNumber();a++)result+="\n",result+=this.getConnectorDesc(a),result+=": ",result+=null===connectable.getIPInfo(a).getIPv4()?"-":connectable.getIPInfo(a).getIPv4();else connectable.getIpMode()===IPMODE_SHARED&&(result+="\n",result+="IP: ",result+=": ",result+=null===connectable.getIPInfo(0).getIPv4()?"-":connectable.getIPInfo(0).getIPv4());return result},this.getMenu=function(){return menu},this.dispose=function(){menu.getVisible()&&menu.hide(),uimanager.deleteMenu(menu),drawable.dispose()},init()},IPInfo=function(){var a=null,b=null,c=null,d=null,e=!1;this.save=function(){var f={};return f.IPv4=e?a:null,f.DNS1=e?b:null,f.DNS2=e?c:null,f.netmask=e?d:null,f["static"]=e,f},this.load=function(f){null!=f&&(a=f.IPv4,b=f.DNS1,c=f.DNS2,d=f.netmask,e=f["static"])},this.sameNetwork=function(b){var c=!1;if(isValidIPv4(b)){var e=ipStringToInt(b),f=e&d,g=a&d;c=f===g}return c},this.setIPv4=function(b){isValidIPv4(b)&&(a=ipStringToInt(b))},this.setNetmask=function(a){isValidIPv4(a)&&(d=ipStringToInt(a))},this.setDNS1=function(a){isValidIPv4(a)&&(b=ipStringToInt(a))},this.setDNS2=function(a){isValidIPv4(a)&&(c=ipStringToInt(a))},this.setStatic=function(a){e=a},this.getIPv4=function(){return ipIntToString(a)},this.getDNS1=function(){return ipIntToString(b)},this.getDNS2=function(){return ipIntToString(c)},this.getNetmask=function(){return ipIntToString(d)},this.getStatic=function(){return e}},ImageLoader=function(a,b){function c(){if(e<a.length){var f=e;e++;var g=new Image;d.push(g),g.onload=function(){c()},g.src=a[f]}else b(d)}var a=a,d=[],e=0,b=b;this.getLoadedImages=function(){return this.loadedImages},this.load=function(){c()}},Link=function(a,b){function c(){i.setLink(l),j.setLink(l);var a=h();m=new UILine(null,null,l,a.x1,a.y1,a.x2,a.y2,0),uimanager.addClickable(m),i.getConnectable().getOwner().getDrawable().addObserver(l),j.getConnectable().getOwner().getDrawable().addObserver(l),n=new UIMenu("Link",0,0,!1),d(),uimanager.addMenu(n)}function d(){n.addEntry("img/64/delete.png","Delete element","deleteSelected();")}function e(a){var b=k[a].orig.getConnectable().getOwner().getDrawable().getCenterX(),c=k[a].orig.getConnectable().getOwner().getDrawable().getCenterY(),d=k[a].dst.getConnectable().getOwner().getDrawable().getCenterX(),e=k[a].dst.getConnectable().getOwner().getDrawable().getCenterY(),f=b+(d-b)*k[a].pos/100,g=c+(e-c)*k[a].pos/100;return{x:f,y:g}}function f(a,b){var c=8;a.font="8pt",a.fillStyle="black";for(var d=b.getStrInfo().split("\n"),e=0;e<d.length;e++)a.fillText(d[e],0,b.getImage().height+c),c+=8}function g(a){for(var b=0;b<k.length;b++){var c=e(b);a.save(),a.translate(c.x,c.y),a.drawImage(k[b].message.getImage(),0,0),f(a,k[b].message),a.restore()}}function h(){return{x1:i.getConnectable().getOwner().getDrawable().getCenterX(),y1:i.getConnectable().getOwner().getDrawable().getCenterY(),x2:j.getConnectable().getOwner().getDrawable().getCenterX(),y2:j.getConnectable().getOwner().getDrawable().getCenterY()}}this.id=getNextID();var i=a,j=b,k=[],l=this,m=null,n=null;this.save=function(){var a={};return a.version=1,a.id=this.id,a.connector1=i.id,a.connector2=j.id,a},this.load=function(a){this.id=a.id},this.drawableChanged=function(){var a=h();m.setCoords(a.x1,a.y1,a.x2,a.y2,0)},this.dispose=function(){uimanager.removeClickable(m),i.getConnectable().getOwner().getDrawable().deleteObserver(l),j.getConnectable().getOwner().getDrawable().deleteObserver(l),n.getVisible()&&n.hide(),uimanager.deleteMenu(n)},this.getConnector1=function(){return i},this.getConnector2=function(){return j},this["delete"]=function(){i.setLink(null),j.setLink(null)},this.addMessage=function(a,b){var c={};c.pos=0,c.message=b,c.orig=a,c.dst=a===i?j:i,k.push(c)},this.draw=function(a,b){var c=h();a.lineWidth=2,a.strokeStyle=b?"blue":"red",a.beginPath(),a.moveTo(c.x1,c.y1),a.lineTo(c.x2,c.y2),a.stroke(),g(a)},this.update=function(){for(var a=[],b=0;b<k.length;b++)k[b].pos+=MSG_ADVANCE,k[b].pos<100?a.push(k[b]):k[b].dst.receive(k[b].message);k=a},this.messageHasCoords=function(a,b,c){var d=e(a);return d.x<=b&&b<=d.x+k[a].message.getImage().width&&d.y<=c&&c<=d.y+k[a].message.getImage().height},this.getMessage=function(a){return k[a].message},this.getMessageCount=function(){return k.length},this.hasCoords=function(a,b){var c=h();return distToSegment({x:a,y:b},{x:c.x1,y:c.y1},{x:c.x2,y:c.y2})<LINE_SELECT_TOLERANCE},this.getCenter=function(){var a={},b=h();return a.x=(b.x1+b.x2)/2,a.y=(b.y1+b.y2)/2,a},this.getMenu=function(){return n},c()},lastMessageId=0,Message=function(a,b,c,d,e,f,g,h,i){var j=b,k=c,l=d,m=e,f=f,g=g,n=h,o=i,p=getNextMessageId(),a=a;this.getId=function(){return p},this.getImage=function(){return o},this.getOriginIP=function(){return j},this.setOriginIP=function(a){j=a},this.getOriginMAC=function(){return l},this.setOriginMAC=function(a){l=a},this.getDestinationIP=function(){return k},this.setDestinationIP=function(a){k=a},this.getDestinationMAC=function(){return m},this.setDestinationMAC=function(a){m=a},this.getOrigPort=function(){return f},this.setOrigPort=function(a){f=a},this.getDstPort=function(){return g},this.setDstPort=function(a){g=a},this.getData=function(){return n},this.getType=function(){return a},this.getStrInfo=function(){var a="Src: "+(null===this.getOriginIP()?"-":this.getOriginIP())+"\n";return a+="Dst: "+(null===this.getDestinationIP()?"-":this.getDestinationIP()),n.description&&(a+="\n",a+=n.description),a}},Network=function(a,b,d,e){function f(a,b,c,d){var e=-1;if(a.isConnected()){var g=a.getConnectedConnector().getConnectable();if(-1===d.indexOf(g))if(g.compatibleIP(b,!1)||g.compatibleMAC(c,!1))e=0;else{for(var h=1e5,i=0;i<g.getConnectorNumber();i++){d.push(g);var j=f(g.getConnector(i),b,c,d);j=-1===j?-1:j+1,-1!==j&&h>j&&(e=g.getConnector(i),h=j)}1e5!==h&&(e=h)}}return e}function g(a){a.getConnector1().setLink(null),a.getConnector2().setLink(null);var b=m.indexOf(a);m.splice(b,1),a.dispose()}function h(a){for(var b=u.getConnectable().getConnectorNumber(),c=0;b>c;c++){var d=u.getConnectable().getConnector(c);null!==d.getLink()&&g(d.getLink())}var e=l.indexOf(a);delete l[e]}function i(a){for(var b=[],c=Object.keys(l),d=0;d<c.length;d++){var e=l[c[d]];if(null!==e.getGroup()){if(!(e.getGroup()in b)){var f={};f.minx=1e6,f.miny=1e6,f.maxx=0,f.maxy=0,b[e.getGroup()]=f}var f=b[e.getGroup()],g=e.getDrawable().getRect();f.minx>g.x&&(f.minx=g.x),f.miny>g.y&&(f.miny=g.y),f.maxx<g.x+g.width&&(f.maxx=g.x+g.width),f.maxy<g.y+g.height&&(f.maxy=g.y+g.height)}}c=Object.keys(b);for(var d=0;d<c.length;d++){var f=b[c[d]];a.strokeStyle="rgba(255,255,255,0.5)",a.lineWidth=4,a.strokeRect(f.minx-10,f.miny-10,f.maxx-f.minx+20,f.maxy-f.miny+20),a.font="16pt",a.fillStyle="rgba(255,255,255,1.0)",a.fillText(c[d],f.minx,f.maxy+20)}}function j(){o.fillStyle="#DDDDDD",o.fillRect(0,0,q,t);for(var a=0;a<m.length;a++)m[a].update(),m[a].draw(o,u===m[a]);for(var b=Object.keys(l),a=0;a<b.length;a++)l[b[a]].getDrawable().draw(o);i(o),uimanager.render(o)}function k(a){m=[],l=[];for(var b=0;b<a.elements.length;b++){var c=null,d=1;a.elements[b].ports?d=a.elements[b].ports:"router"===a.elements[b].type&&(d=2),c=new Host(a.elements[b].type,d),c.load(a.elements[b]),l[c.id]=c}for(var b=0;b<a.links.length;b++){var e=p.findConnector(a.links[b].connector1),f=p.findConnector(a.links[b].connector2),g=new Link(e,f);g.load(a.links[b]),m.push(g)}lastusedid=a.lastusedid}var l=[],m=[],n=a,o=b,p=this,q=d,t=e,u=null;this.init=function(){setInterval(j,REFRESH_INTERVAL)},this.getImages=function(){return n},this.createComputer=function(a,b){c=new Host("computer",1),c.getDrawable().setPosition(a,b),c.getDrawable().setImage(n[IMAGE_COMPUTER]);var d=new DHCPClient(0);c.addApp(d,-1,!1);var e=new DNSClient(0);c.addApp(e,-1,!1);var f=new HTTPClient(0);return c.addApp(f,-1,!1),l[c.id]=c,c.id},this.createDHCPServer=function(a,b){c=new Host("dhcpserver",1),c.getDrawable().setPosition(a,b),c.getDrawable().setImage(n[IMAGE_SERVERDHCP]);var d=new DHCPServer(0);return c.addApp(d,67,!0),l[c.id]=c,c.id},this.createDNSServer=function(a,b){c=new Host("dnsserver",1),c.getDrawable().setPosition(a,b),c.getDrawable().setImage(n[IMAGE_SERVERDNS]);var d=new DNSServer(0);return c.addApp(d,53,!0),l[c.id]=c,c.id},this.createHTTPServer=function(a,b){c=new Host("httpserver",1),c.getDrawable().setPosition(a,b),c.getDrawable().setImage(n[IMAGE_SERVERWEB]);var d=new HTTPServer(0);return c.addApp(d,80,!0),l[c.id]=c,c.id},this.createSwitch=function(a,b,c){return s=new Host("switch",c),s.getDrawable().setPosition(a,b),s.getDrawable().setImage(n[IMAGE_SWITCH]),l[s.id]=s,s.id},this.createRouter=function(a,b){return r=new Host("router",2),r.getDrawable().setPosition(a,b),r.getDrawable().setImage(n[IMAGE_ROUTER]),l[r.id]=r,r.id},this.createLink=function(a,b,c,d){var e=l[a],f=l[c],g=e.getConnectable().getConnector(b),h=f.getConnectable().getConnector(d),i=!1;if(null!==g&&null!==h){var j=new Link(g,h);m.push(j),i=m.length}return i},this.getElement=function(a){var b=null;return b=l[a]},this.getLink=function(a){var b=null;return a<m.length&&(b=m[a]),b},this.findNextConnectorInPath=function(a,b,c){for(var d=null,e=1e5,g=0;g<a.getConnectorNumber();g++){var h=[];h.push(a);var i=f(a.getConnector(g),b,c,h);i=-1===i?-1:i+1,-1!==i&&e>i&&(d=a.getConnector(g),e=i)}return d},this.getElementInCoords=function(a,b){for(var c=null,d=0,e=Object.keys(l);null===c&&d<e.length;)l[e[d]].getDrawable().hasCoords(a,b)?c=l[e[d]]:d++;return c},this.getMessageInCoords=function(a,b){for(var c=null,d=0;null===c&&d<m.length;){for(var e=m[d].getMessageCount(),f=0;null===c&&e>f;)m[d].messageHasCoords(f,a,b)?c=m[d].getMessage(f):f++;null===c&&d++}return c},this.getPosForElement=function(a){return l.indexOf(a)},this.getLinkInCoords=function(a,b){for(var c=null,d=0;null===c&&d<m.length;)m[d].hasCoords(a,b)?c=m[d]:d++;return c},this.setSelected=function(a){u=a},this.getSelected=function(){return u},this.deleteSelectedLink=function(){g(u),u=null},this.deleteSelectedElement=function(){h(u),u.dispose(),u=null},this.save=function(){var a={};a.version=1,a.lastusedid=lastusedid,a.elements=[],a.links=[];for(var b=Object.keys(l),c=0;c<b.length;c++)a.elements.push(l[b[c]].save());for(var c=0;c<m.length;c++)a.links.push(m[c].save());return JSON.stringify(a)},this.load=function(a){switch(uimanager.reset(),a.version){case 1:k(a)}},this.findConnector=function(a){for(var b=Object.keys(l),c=null,d=0;null===c&&d<b.length;)c=l[b[d]].getConnectable().findConnector(a),d++;return c}},Router=function(){function a(){b=new Connectable(d,MACMODE_UNIQUE,IPMODE_UNIQUE,!0,!0),new Connector(b),new Connector(b),c=new Drawable(d)}this.id=getNextID();var b=null,c=null,d=this;this.save=function(){var a={};return a.version=1,a.id=this.id,a.type="router",a.drawable=c.save(),a.connectable=b.save(),a},this.load=function(a){this.id=a.id,type=a.type,c.load(a.drawable),c.setImage(network.getImages()[IMAGE_ROUTER]),b.load(a.connectable)},this.getConnectable=function(){return b},this.getDrawable=function(){return c},this.getStrInfo=function(){return lan="-",wan="-",null!=b.getIPInfo(ROUTER_LAN)&&null!=b.getIPInfo(ROUTER_LAN).getIPv4()&&(lan=b.getIPInfo(ROUTER_LAN).getIPv4()),null!=b.getIPInfo(ROUTER_WAN)&&null!=b.getIPInfo(ROUTER_WAN).getIPv4()&&(wan=b.getIPInfo(ROUTER_WAN).getIPv4()),result="LAN: "+lan+"\nWAN: "+wan,result},this.getNATInfo=function(){return b.getTrafficManager().getFixedNATtable()},a()},Switch=function(a){function b(){c=new Connectable(e,MACMODE_SHARED,IPMODE_NOIP,!1,!1);for(var b=0;a>b;b++){new Connector(c)}d=new Drawable(e)}this.id=getNextID();var c=null,d=null,e=this,a=a;this.save=function(){var b={};return b.version=1,b.id=this.id,b.type="switch",b.drawable=d.save(),b.connectable=c.save(),b.ports=a,b},this.load=function(a){this.id=a.id,type=a.type,d.load(a.drawable),d.setImage(network.getImages()[IMAGE_SWITCH]),c.load(a.connectable)},this.getConnectable=function(){return c},this.getDrawable=function(){return d},this.getStrInfo=function(){return""},b()},TrafficManager=function(a,b,c){function d(d,e){var f=!1,j=!1;if(f=a.compatibleMAC(e.getDestinationMAC(),!0),j=!f||a.compatibleBroadcastMAC(e.getDestinationMAC())&&!b,f)if(e.getDstPort()in g)g[e.getDstPort()].app.receiveMessage(e),g[e.getDstPort()].fixed||delete g[e.getDstPort()];else if(c&&!a.compatibleBroadcastMAC(e.getDestinationMAC()))if(e.getDstPort()in h&&h[e.getDstPort()].originIface==a.getConnectorPos(d)){var k=e.getDstPort();e.setDestinationIP(h[k].ip),e.setDstPort(h[k].port);var l=a.getDstMAC(e.getDestinationIP());if(null!==l){var m=a.getSenderConnectorForMAC(l);null!==m&&(e.setDestinationMAC(l),m.send(e))}h[k].fixed||delete h[k]}else{var n=getDinamycPort(),l=a.getDstMAC(e.getDestinationIP());if(null!==l){var m=a.getSenderConnectorForMAC(l);if(null!==m){var o=a.getConnectorPos(m);m!==d&&(i.addNATEntry(n,e.getOrigPort(),e.getOriginIP(),o,!1),e.setOriginIP(a.getIPInfo(o).getIPv4()),e.setOriginMAC(a.getMAC(o)),e.setOrigPort(n)),e.setDestinationMAC(l),m.send(e)}}}else if(!a.compatibleBroadcastMAC(e.getDestinationMAC())){var l=a.getDstMAC(e.getDestinationIP());if(null!==l){var m=a.getSenderConnectorForMAC(l);null!==m&&(e.setDestinationMAC(l),m.send(e))}}j&&i.sendMessage(d,e)}function e(b,d){var e=a.compatibleMAC(d.getDestinationMAC(),!1),g=null!==b.getIPInfo()&&d.getDestinationIP()===b.getIPInfo().getIPv4();switch(d.getData().command){case"ping":if(e&&g){var h=d.getOriginIP(),j=a.getConnectorPos(b),l=d.getId();i.pingResponse(h,j,l)}else if(e&&!g&&c){var m=a.getDstMAC(d.getDestinationIP());if(null!==m){var n=a.getSenderConnectorForMAC(m);if(null!==n){if(n!==b){var o=a.getConnectorPos(n),p={};p.ip=d.getOriginIP(),p.mac=d.getOriginMAC(),k[d.getId()]=p,d.setOriginIP(a.getIPInfo(o).getIPv4()),d.setOriginMAC(a.getMAC(o))}d.setDestinationMAC(m),n.send(d)}}}else if(!e||g||c)e||i.sendMessage(b,d);else{var m=a.getDstMAC(d.getDestinationIP());if(null!==m){var n=a.getSenderConnectorForMAC(m);null!==n&&(d.setDestinationMAC(m),n.send(d))}}break;case"traceroute":if(e&&g){var h=d.getOriginIP(),j=a.getConnectorPos(b),l=d.getId();i.tracerouteResponse(h,j,l,!0,d.getData().seq+1,d.getDestinationIP())}else if(e&&!g&&c){var m=a.getDstMAC(d.getDestinationIP());if(null!==m){var n=a.getSenderConnectorForMAC(m);if(null!==n){var h=d.getOriginIP(),j=a.getConnectorPos(b),l=d.getId(),q=d.getData().seq+1;if(i.tracerouteResponse(h,j,l,!1,q,d.getDestinationIP()),n!==b){var o=a.getConnectorPos(n),p={};p.ip=d.getOriginIP(),p.mac=d.getOriginMAC(),k[d.getId()]=p,d.setOriginIP(a.getIPInfo(o).getIPv4()),d.setOriginMAC(a.getMAC(o))}d.getData().seq=q,d.setDestinationMAC(m),n.send(d)}}}else if(!e||g||c)e||i.sendMessage(b,d);else{var m=a.getDstMAC(d.getDestinationIP());if(null!==m){var n=a.getSenderConnectorForMAC(m);if(null!==n){var h=d.getOriginIP(),j=a.getConnectorPos(b),l=d.getId(),q=d.getData().seq+1;i.tracerouteResponse(h,j,l,!1,q,d.getDestinationIP());var o=a.getConnectorPos(n);d.getData().seq=q,d.setOriginMAC(a.getMAC(o)),d.setDestinationMAC(m),n.send(d)}}}break;case"pingresponse":if(e&&d.getData().originMessageId in k)d.setDestinationIP(k[d.getData().originMessageId].ip),d.setDestinationMAC(k[d.getData().originMessageId].mac),i.sendMessage(b,d),delete k[d.getData().originMessageId];else if(!e||!g||d.getData().originMessageId in k)if(!e||g||d.getData().originMessageId in k)e||i.sendMessage(b,d);else{var m=a.getDstMAC(d.getDestinationIP());if(null!==m){var n=a.getSenderConnectorForMAC(m);null!==n&&(d.setDestinationMAC(m),n.send(d))}}else f("Ping response recieved from "+d.getOriginIP());break;case"tracerouteresponse":if(e&&d.getData().originMessageId in k)d.setDestinationIP(k[d.getData().originMessageId].ip),d.setDestinationMAC(k[d.getData().originMessageId].mac),i.sendMessage(b,d),d.getData()["final"]&&delete k[d.getData().originMessageId];else if(!e||!g||d.getData().originMessageId in k)if(!e||g||d.getData().originMessageId in k)e||i.sendMessage(b,d);else{var m=a.getDstMAC(d.getDestinationIP());if(null!==m){var n=a.getSenderConnectorForMAC(m);null!==n&&(d.setDestinationMAC(m),n.send(d))}}else f(d.getData().seq+" - Traceroute to "+d.getData().dstIp+": "+d.getOriginIP())}}function f(a){j.push(a);var b=document.getElementById("diagnosticsconsole");null!==b&&(b.innerHTML=i.getDiagnosticsInfo())}this.id=getNextID();var a=a,g=[],b=b,c=c,h=[],i=this,j=[],k=[];this.save=function(){var a={};a.version=1,a.id=this.id,a.limitbroadcast=b,a.performNAT=c,a.NATtable=[];for(var d in h)h[d].fixed&&a.NATtable.push(h[d]);return a},this.load=function(a){this.id=a.id,b=a.limitbroadcast,c=a.performNAT;for(var d=0;d<a.NATtable.length;d++)this.addNATEntry(a.NATtable[d].newport,a.NATtable[d].port,a.NATtable[d].ip,a.NATtable[d].originIface?a.NATtable[d].originIface:ROUTER_WAN,a.NATtable[d].fixed)},this.registerApplication=function(a,b,c){var d={};d.app=a,d.port=b,d.fixed=c,g[b]=d},this.sendMessage=function(c,d){if(!b&&a.compatibleBroadcastMAC(d.getDestinationMAC()))for(var e=0;e<a.getConnectorNumber();e++){var f=a.getConnector(e);f!==c&&f.send(d)}else{var f=a.getSenderConnectorForMAC(d.getDestinationMAC());f!==c&&null!==f&&f.send(d)}},this.addNATEntry=function(a,b,c,d,e){h[a]={},h[a].ip=c,h[a].newport=a,h[a].port=b,h[a].originIface=d,h[a].fixed=e},this.getNATData=function(){var a=[];for(port in h)if(h[port].fixed){var b=[];b[0]=h[port].originIface,b[1]=h[port].port,b[2]=h[port].newport,b[3]=h[port].ip,a.push(b)}return a},this.removeFixedNATData=function(){for(port in h)h[port].fixed&&this.deleteNATEntry(port)},this.deleteNATEntry=function(a){a in h&&delete h[a]},this.proccess=function(b,c){switch(a.updateAddressing(c.getOriginMAC(),a.getConnectorPos(b)),c.getType()){case"tcp":d(b,c);
break;case"icmp":e(b,c)}},this.getFixedNATtable=function(){var a=[];for(var b in h)h[b].fixed&&(a[b]={},a[b].port=h[b].port,a[b].ip=h[b].ip);return a},this.getDiagnosticsInfo=function(){for(var a="",b=j.length>15?j.length-16:0;b<j.length;b++)a+=j[b]+(b===j.length?"":"<br/>");return a},this.ping=function(b,c){var d=null;if(d=isValidIPv4(b)?b:a.getOwner().getApp("DNSClient").getIp(b),null===d)f("Unknown domain: "+b);else{var e=a.getDstMAC(d);if(null!==e){var g={};g.command="ping",g.description="PING: "+d;var h=new Message("icmp",a.getIPInfo(c).getIPv4(),d,a.getMAC(c),e,-1,-1,g,images[IMAGE_ENVELOPEICMP]);a.getConnector(c).send(h)}}},this.traceroute=function(b,c){var d=null;if(d=isValidIPv4(b)?b:a.getOwner().getApp("DNSClient").getIp(b),null===d)f("Unknown domain: "+b);else{var e=a.getDstMAC(d);if(null!==e){var g={};g.command="traceroute",g.description="Traceroute: "+d,g.seq=0;var h=new Message("icmp",a.getIPInfo(c).getIPv4(),d,a.getMAC(c),e,-1,-1,g,images[IMAGE_ENVELOPEICMP]);a.getConnector(c).send(h)}}},this.pingResponse=function(b,c,d){var e=null;if(e=isValidIPv4(b)?b:a.getOwner().getApp("DNSClient").getIp(b),null===e)f("Unknown domain: "+b);else{var g=a.getDstMAC(e);if(null!==g){var h={};h.command="pingresponse",h.description="PING Response",h.originMessageId=d;var i=new Message("icmp",a.getIPInfo(c).getIPv4(),e,a.getMAC(c),g,-1,-1,h,images[IMAGE_ENVELOPEICMP]);a.getConnector(c).send(i)}}},this.tracerouteResponse=function(b,c,d,e,g,h){var i=null;if(i=isValidIPv4(b)?b:a.getOwner().getApp("DNSClient").getIp(b),null===i)f("Unknown domain: "+b);else{var j=a.getDstMAC(i);if(null!==j){var k={};k.command="tracerouteresponse",k.originMessageId=d,k["final"]=e,k.seq=g,k.dstIp=h,k.description="Traceroute Response";var l=new Message("icmp",a.getIPInfo(c).getIPv4(),i,a.getMAC(c),j,-1,-1,k,images[IMAGE_ENVELOPEICMP]);a.getConnector(c).send(l)}}},this.setPerformNAT=function(a){c=a}};UILine.prototype=new UIClickable,UILine.prototype.constructor=UILine;var UIManager=function(){function a(){K.getVisible()?K.hide():K.show()}function b(){var b=document.getElementById("simcanvas");b.addEventListener("mousedown",c,!1),b.addEventListener("mouseup",d,!1),b.addEventListener("mousemove",e,!1);var f=b.getBoundingClientRect();K=new UIMenu("<strong>Main menu</strong>",42+f.left,3,!0),K.addEntry("img/64/upload.png","Upload","uploadClick();"),K.addEntry("img/64/save.png","Save","saveNetwork();"),K.addEntry("img/64/computer.png","Add Host",'newElement("host");'),K.addEntry("img/64/server_dhcp.png","Add DHCP server",'newElement("dhcp");'),K.addEntry("img/64/server_dns.png","Add DNS server",'newElement("dns");'),K.addEntry("img/64/server_web.png","Add web server",'newElement("web");'),K.addEntry("img/64/switch.png","Add switch",'newElement("switch");'),K.addEntry("img/64/router2.png","Add router",'newElement("router");'),L.addMenu(K);var g=new UIRectangle(a,null,K,5,5,35,50,10,!0);L.addClickable(g)}function c(a){var b=document.getElementById("simcanvas"),c=b.getBoundingClientRect(),d=a.clientX-c.left*(b.width/c.width),e=a.clientY-c.top*(b.height/c.height);m(d,e,z)}function d(a){var b=document.getElementById("simcanvas"),c=b.getBoundingClientRect(),d=a.clientX-c.left*(b.width/c.width),e=a.clientY-c.top*(b.height/c.height);m(d,e,A)}function e(a){var b=document.getElementById("simcanvas"),c=b.getBoundingClientRect(),d=a.clientX-c.left*(b.width/c.width),e=a.clientY-c.top*(b.height/c.height);P=d,Q=e,m(d,e,B)}function f(){for(var a in G)G[a].getVisible()&&G[a].hide()}function g(a,b,c){var d=a.getRect();M=b-d.x,N=c-d.y}function h(a){a.getVisible()?a.hide():a.show()}function i(a){network.setSelected(a),a.getDrawable().addObserver(L);var b=a.getDrawable().getRect();O=new UIRectangle(h,a.getMenu(),L,b.x+b.width-10,b.y,10,10,50),L.addClickable(O)}function j(a){network.setSelected(a);var b=a.getCenter();O=new UIRectangle(h,a.getMenu(),L,b.x-5,b.y-5,10,10,50),a.getMenu().setPos(b.x+5,b.y-5),L.addClickable(O)}function k(a){null!==a&&a.getMenu().getVisible()&&(a.getMenu().hide(),a.getDrawable().deleteObserver(L)),L.removeClickable(O),network.setSelected(null)}function l(){network.setSelected(null)}function m(a,b,c){switch(J){case r:switch(c){case z:var d=n(a,b);null!==d&&(d.getObject()===K?(f(),d.performAction(),J=w):d.getObject()instanceof Drawable?(g(d.getObject(),a,b),f(),i(d.getObject().getOwner()),J=s):d.getObject()instanceof Link&&(f(),j(d.getObject()),J=u))}break;case w:switch(c){case z:var d=n(a,b);null!==d?d.getObject()===K?(d.performAction(),J=r):d.getObject()instanceof Drawable?(g(d.getObject(),a,b),K.hide(),i(d.getObject().getOwner()),J=s):d.getObject()instanceof Link&&(f(),j(d.getObject()),J=u):(K.hide(),J=r);break;case C:K.hide(),J=r}break;case s:switch(c){case A:J=t;break;case B:network.getSelected().getDrawable().setPosition(a-M,b-N)}break;case t:switch(c){case z:var d=n(a,b);null!==d?d.getObject()===K?(f(),d.performAction(),network.setSelected(null),J=w):d.getObject()instanceof Drawable?(f(),k(network.getSelected()),i(d.getObject().getOwner()),J=s):d.getObject()instanceof UIManager?(d.performAction(),J=x):d.getObject()instanceof Link&&(f(),j(d.getObject()),J=u):(network.setSelected(null),J=r)}break;case u:switch(c){case z:var d=n(a,b);null!==d?d.getObject()===K?(f(),d.performAction(),network.setSelected(null),J=w):d.getObject()instanceof Drawable?(f(),l(network.getSelected()),i(d.getObject().getOwner()),J=s):d.getObject()instanceof UIManager?(d.performAction(),J=y):d.getObject()instanceof Link&&(f(),j(d.getObject()),J=u):(network.setSelected(null),J=r)}break;case y:switch(c){case z:var d=n(a,b);null!==d?d.getObject()===K?(f(),d.performAction(),network.setSelected(null),J=w):d.getObject()instanceof Drawable?(f(),l(network.getSelected()),i(d.getObject().getOwner()),J=s):d.getObject()instanceof UIManager?(d.performAction(),J=u):d.getObject()instanceof Link&&(f(),j(d.getObject()),J=u):(f(),l(network.getSelected()),J=r);break;case E:f(),l(network.getSelected()),J=r}break;case x:switch(c){case z:var d=n(a,b);null!==d?d.getObject()===K?(f(),d.performAction(),network.setSelected(null),J=w):d.getObject()instanceof Drawable?(f(),k(network.getSelected()),i(d.getObject().getOwner()),J=s):d.getObject()instanceof UIManager?(d.performAction(),J=x):d.getObject()instanceof Link&&(f(),j(d.getObject()),J=u):(k(network.getSelected()),f(),J=r);break;case C:f(),J=t;break;case D:f(),k(network.getSelected()),J=r;break;case F:f(),J=v}break;case v:switch(c){case z:var d=n(a,b);null!==d?d.getObject()instanceof Drawable&&(f(),selectLinkConnectors(network.getSelected().id,d.getObject().getOwner().id),J=t):(f(),J=t)}}}function n(a,b){for(var c=null,d=0;d<H.length;d++)H[d].isInCoords(a,b)&&(null===c||H[d].Z>c.Z)&&(c=H[d]);return c}function o(a){a.fillStyle="rgba(255,255,255,0.5)",a.fillRect(5,document.body.scrollTop+5,35,50),a.strokeStyle="rgba(255,255,255,1.0)",a.lineWidth=4,a.strokeRect(5,document.body.scrollTop+5,35,50),a.lineWidth=5;for(var b=15;50>b;b+=10)a.strokeRect(12,document.body.scrollTop+b,21,0)}function p(a){if(J===s||J===t||J===x||J===v){var b=network.getSelected().getDrawable().getRect();a.strokeStyle="rgba(100,100,100,0.75)",a.lineWidth=5,a.strokeRect(b.x,b.y,b.width,b.height),a.fillStyle="rgba(255,255,255,0.75)",a.strokeStyle="rgba(255,255,255,0.75)",a.fillRect(O.X,O.Y,O.W,O.H),a.lineWidth=2,a.strokeRect(O.X,O.Y,O.W,O.H)}else if(J===u||J===y){var c=network.getSelected().getCenter();a.fillStyle="rgba(255,255,255,0.75)",a.strokeStyle="rgba(255,255,255,0.75)",a.fillRect(c.x-5,c.y-5,10,10),a.lineWidth=2,a.strokeRect(c.x-5,c.y-5,10,10)}}function q(a){if(J===v){var b=network.getSelected().getDrawable().getRect(),c=b.x+b.width/2,d=b.y+b.height/2;a.strokeStyle="rgba(128,255,128,1.0)",a.lineWidth=2,a.beginPath(),a.moveTo(c,d),a.lineTo(P,Q),a.stroke()}}var r=0,s=1,t=2,u=3,v=5,w=6,x=7,y=8,z=0,A=1,B=2,C=3,D=4,E=5,F=6,G=[],H=[],I=[],J=(document.getElementById("simcanvas"),r),K=null,L=this,M=0,N=0,O=null,P=0,Q=0;this.addWindow=function(a){I[a.getId()]=a},this.getWindow=function(a){return I[a]},this.removeWindow=function(a){delete I[a.getId()]},this.reset=function(){this.clickables=[];var b=new UIRectangle(a,null,K,5,5,35,50,10,!0);this.addClickable(b)},this.drawableChanged=function(){if(null!==network.getSelected()){var a=network.getSelected().getDrawable().getRect();O.X=a.x+a.width-10,O.Y=a.y}},this.menuOptionClicked=function(){m(-1,-1,C)},this.selectedElementDeleted=function(){m(-1,-1,D)},this.selectedLineDeleted=function(){m(-1,-1,E)},this.createLinkAction=function(){m(-1,-1,F)},this.addMenu=function(a){G[a.getId()]=a},this.deleteMenu=function(a){delete G[a.getId()]},this.getMenu=function(a){return G[a]},this.addClickable=function(a){H.push(a)},this.removeClickable=function(a){var b=H.indexOf(a);H.splice(b,1)},this.render=function(a){p(a),q(a),o(a)},b()},UIMenu=function(a,b,c,d){var b=b,c=c,e=[],f="uimenu_"+getNextID(),a=a,g=!1,d=d;this.getId=function(){return f},this.getVisible=function(){return g},this.addEntry=function(a,b,c){var d={};d.img=a,d.text=b,d.js=c,e.push(d)},this.setPos=function(a,d){b=a,c=d},this.setDescription=function(b){a=b},this.purge=function(){e=[]},this.show=function(){var h=document.createElement("div");h.setAttribute("id",f),h.setAttribute("style","width:200px;background-color:#EEEEEE;border:3px solid white;position:"+(d?"fixed":"absolute")+";top:"+c+"px;left:"+b+"px;font-size:0.8em;padding:0px 10px 0px;");for(var i=a+"<hr/>",j=0;j<e.length;j++)i+="<a href='#' onclick='"+e[j].js+"uimanager.menuOptionClicked();'>",i+="<img src='"+e[j].img+"' style='max-height:32px;max-width:32px;' />",i+=e[j].text+"</a><br/>",j!==e.length-1&&(i+="<hr/>");h.innerHTML=i,document.body.appendChild(h),g=!0},this.hide=function(){var a=document.getElementById(f);document.body.removeChild(a),g=!1}};UIRectangle.prototype=new UIClickable,UIRectangle.prototype.constructor=UIRectangle;var lasttableid=0,uitables=[],UITable=function(a,b,c){var a=a,b=b,c=c,d="uitable_"+getNextTableID(),e=!1,f=null,g=[];uitables[d]=this,this.getId=function(){return d},this.setParam=function(a,b){g[a]=b},this.getParam=function(a){var b=null;return a in g&&(b=g[a]),b},this.setSecondary=function(a,b){e=a,f=b},this.render=function(){var g="";g+="<tr>";for(var h=0;h<a.length;h++)g+="<th>"+a[h]+"</th>";g+="<th>Controls</th>",g+="</tr>";for(var h=0;h<b.length;h++){g+="<tr>";for(var i=0;i<a.length;i++){var j=c+"_"+h+"_"+i;g+="<td>",g+='<input type="text" id="'+j+'" value="'+b[h][i]+'" disabled="disabled" />',g+="</td>"}g+="<td>",g+='<img src="img/64/delete.png" title="Delete" alt="Delete" style="width:24px;" onclick="deleteUITableRow(\''+d+"',"+h+')" />',e&&(g+='<img src="img/64/edit.png" title="Edit" alt="Edit" style="width:24px;" onclick="'+f+"('"+d+"',"+h+')" />'),g+="</td>",g+="</tr>"}g+="<tr>";for(var i=0;i<a.length;i++){var j=c+"_new_"+i;g+="<td>",g+='<input type="text" id="'+j+'" />',g+="</td>"}g+='<td><img src="img/64/add.png" title="Add" alt="Add" style="width:24px;" onclick="addUITableRow(\''+d+"')\" /></td>",g+="</tr>",document.getElementById(c).innerHTML=g},this.deleteRow=function(a){b.splice(a,1),this.render()},this.dispose=function(){delete uitables[d]},this.getData=function(){return b},this.addRow=function(){for(var d=[],e=0;e<a.length;e++){var f=c+"_new_"+e,g=document.getElementById(f).value;d.push(g)}b.push(d),this.render()}},UIWindow=function(a,b,c,d,e,f){function g(a){var b=x.getBoundingClientRect(),c=a.clientX,d=a.clientY;b.left<=c&&c<=b.left+b.width&&b.top<=d&&d<=b.top+b.height&&j(c,d,p)}function h(){j(-1,-1,q)}function i(){var a=event.clientX,b=event.clientY;j(a,b,r)}function j(a,b,c){switch(o){case m:switch(c){case q:o=n;break;case r:s=a-A+scrollX,t=b-B+scrollY,w.setAttribute("style",k())}break;case n:switch(c){case p:var d=x.getBoundingClientRect();A=a-d.left,B=b-d.top,o=m}}}function k(){return"position:absolute;top:"+t+"px;left:"+s+"px;z-index:110;background-color:white;width:"+c+"px;height:"+d+"px;border-radius:10px;border:1px solid;padding:10px;text-align:center;opacity:"+f+";"}function l(){w=document.createElement("div"),w.setAttribute("id",a),w.setAttribute("style",k()),x=document.createElement("div"),x.setAttribute("id",a+"_title"),x.setAttribute("style","width:100%;height:20px;background-color:blue;color:white;font-weight:bold;"),x.innerHTML=b,y=document.createElement("div"),y.setAttribute("id",u),y.setAttribute("style","width:100%; height:"+d-80+"px;"),z=document.createElement("div"),z.setAttribute("id",v),z.setAttribute("style","width:100%; height:40px;"),window.addEventListener("mousedown",g,!0),window.addEventListener("mouseup",h,!0),window.addEventListener("mousemove",i,!0),uimanager.addWindow(C)}var m=0,n=1,o=n,p=0,q=1,r=2,b=b,c=c,d=d,s=window.innerWidth/2-c/2,t=window.innerHeight/2-d/2,f=f,a=a,u=u+"_contents",v=v+"_controls",w=null,x=null,y=null,z=null,A=0,B=0,C=this;this.render=function(){w.appendChild(x),w.appendChild(y),w.appendChild(z),document.body.appendChild(w)},this.setControls=function(a){z.innerHTML=a},this.setContent=function(a){y.innerHTML=a},this.dispose=function(){window.removeEventListener("mousedown",g),window.removeEventListener("mouseup",h),window.removeEventListener("mousemove",i),uimanager.removeWindow(this),removeBodyDiv(a)},this.getId=function(){return a},l()};